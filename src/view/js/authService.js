// authService.js
// Respons√°vel por gerenciar autentica√ß√£o e tokens de acesso
import { mostrarNotificacao } from './notificationService.js';

const API_BASE_URL = 'https://lightsalmon-alpaca-756067.hostingersite.com/api';
const TOKEN_STORAGE_KEY = 'finance_app_token';
const USER_STORAGE_KEY = 'finance_app_user';

let currentUser = null;
let currentToken = null;
let initApplicationCallback = null;

// Fun√ß√£o para definir callback de inicializa√ß√£o
export function setInitApplicationCallback(callback) {
    initApplicationCallback = callback;
}

export function initAuth() {
    // Carregar dados de autentica√ß√£o salvos
    loadStoredAuth();
    
    // Verificar se o usu√°rio j√° est√° logado
    if (currentToken && currentUser) {
        showDashboard();
    } else {
        showLoginScreen();
    }
}

function loadStoredAuth() {
    try {
        const storedToken = localStorage.getItem(TOKEN_STORAGE_KEY);
        const storedUser = localStorage.getItem(USER_STORAGE_KEY);
        
        if (storedToken && storedUser) {
            currentToken = storedToken;
            currentUser = JSON.parse(storedUser);
        }
    } catch (error) {
        console.warn('Erro ao carregar dados de autentica√ß√£o:', error);
        clearStoredAuth();
    }
}

function saveAuth(token, user) {
    currentToken = token;
    currentUser = user;
    
    localStorage.setItem(TOKEN_STORAGE_KEY, token);
    localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(user));
}

function clearStoredAuth() {
    currentToken = null;
    currentUser = null;
    
    localStorage.removeItem(TOKEN_STORAGE_KEY);
    localStorage.removeItem(USER_STORAGE_KEY);
}

export async function login(email, password) {
    try {
        const response = await fetch(`${API_BASE_URL}/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.message || 'Erro na autentica√ß√£o');
        }

        if (!data.token || !data.user) {
            throw new Error('Resposta inv√°lida do servidor');
        }

        // Salvar dados de autentica√ß√£o
        saveAuth(data.token, data.user);
        
        mostrarNotificacao('Sucesso', `Bem-vindo(a), ${data.user.name}!`, 'success');
        
        // Mostrar dashboard
        showDashboard();
        
        return { success: true, user: data.user, token: data.token };

    } catch (error) {
        console.error('Erro no login:', error);
        mostrarNotificacao('Erro', error.message, 'error');
        return { success: false, error: error.message };
    }
}

export function logout() {
    clearStoredAuth();
    showLoginScreen();
    mostrarNotificacao('Info', 'Logout realizado com sucesso', 'info');
}

export function getCurrentUser() {
    return currentUser;
}

export function getCurrentToken() {
    return currentToken;
}

export function isAuthenticated() {
    return !!(currentToken && currentUser);
}

export async function syncWithAPI() {
    console.log('üîÑ [syncWithAPI] Iniciando fun√ß√£o syncWithAPI...');
    
    if (!isAuthenticated()) {
        console.error('‚ùå [syncWithAPI] Usu√°rio n√£o autenticado');
        throw new Error('Usu√°rio n√£o autenticado');
    }

    console.log('‚úÖ [syncWithAPI] Usu√°rio autenticado, continuando...');
    console.log('üîë [syncWithAPI] Token atual:', currentToken ? `${currentToken.substring(0, 20)}...` : 'NULL');
    console.log('üåê [syncWithAPI] URL da API:', `${API_BASE_URL}/financas`);

    try {
        const requestData = {
            url: `${API_BASE_URL}/financas`,
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${currentToken}`,
                'Content-Type': 'application/json'
            }
        };
        
        console.log('üì§ [syncWithAPI] Dados da requisi√ß√£o:', requestData);
        console.log('‚è≥ [syncWithAPI] Fazendo requisi√ß√£o HTTP via IPC...');

        // Usar o m√©todo IPC do Electron ao inv√©s de fetch direto
        const response = await window.electronAPI.fazerRequisicaoHTTP(requestData);

        console.log('üì• [syncWithAPI] Resposta completa da requisi√ß√£o HTTP:', response);
        console.log('üìä [syncWithAPI] Status da resposta:', response?.response?.status);
        console.log('üìã [syncWithAPI] Headers da resposta:', response?.response?.headers);

        if (!response.success) {
            console.error('‚ùå [syncWithAPI] Erro na requisi√ß√£o:', response.error);
            throw new Error(`Erro na requisi√ß√£o: ${response.error}`);
        }

        console.log('‚úÖ [syncWithAPI] Requisi√ß√£o bem-sucedida');

        if (response.response.status === 401) {
            console.warn('üîí [syncWithAPI] Token expirado, fazendo logout...');
            // Token expirado - fazer logout e solicitar novo login
            logout();
            throw new Error('Sess√£o expirada. Fa√ßa login novamente.');
        }

        if (response.response.status !== 200) {
            console.error(`‚ùå [syncWithAPI] Status HTTP inv√°lido: ${response.response.status}`);
            throw new Error(`HTTP ${response.response.status}: ${response.response.statusText || 'Erro na API'}`);
        }

        const result = response.response.data;
        console.log('üì¶ [syncWithAPI] Dados recebidos da API (result):', result);
        console.log('üîç [syncWithAPI] Tipo de dados recebidos:', typeof result);
        console.log('üìè [syncWithAPI] Tamanho dos dados (se for objeto):', result && typeof result === 'object' ? Object.keys(result).length : 'N/A');
        
        if (!result) {
            console.error('‚ùå [syncWithAPI] Nenhum dado retornado da API');
            throw new Error('Nenhum dado retornado da API');
        }
        
        if (typeof result === 'object' && result.success === false) {
            console.error('‚ùå [syncWithAPI] API retornou erro:', result.message);
            throw new Error(result.message || 'Erro ao sincronizar dados');
        }

        // Se a API retorna diretamente os dados ou se tem uma propriedade 'data'
        const finalData = result.data || result;
        console.log('üéØ [syncWithAPI] Dados finais que ser√£o retornados:', finalData);
        
        return finalData;

    } catch (error) {
        console.error('üí• [syncWithAPI] Erro capturado na sincroniza√ß√£o:', error);
        console.error('üí• [syncWithAPI] Tipo do erro:', typeof error);
        console.error('üí• [syncWithAPI] Mensagem do erro:', error.message);
        console.error('üí• [syncWithAPI] Stack trace:', error.stack);
        
        // Se o erro for de autentica√ß√£o, fazer logout
        if (error.message.includes('401') || error.message.includes('expirada')) {
            console.warn('üîê [syncWithAPI] Erro de autentica√ß√£o detectado, fazendo logout...');
            logout();
        }
        
        throw error;
    }
}

export function initLoginForm() {
    const loginForm = document.getElementById('login-form');
    const loginButton = document.getElementById('login-button');
    
    if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                mostrarNotificacao('Erro', 'Por favor, preencha todos os campos', 'error');
                return;
            }
            
            // Mostrar loading
            setLoginLoading(true);
            
            try {
                await login(email, password);
            } finally {
                // Restaurar bot√£o
                setLoginLoading(false);
            }
        });
    }
    
    // Toggle de mostrar/ocultar senha
    const togglePassword = document.getElementById('toggle-password');
    const passwordInput = document.getElementById('login-password');
    
    if (togglePassword && passwordInput) {
        togglePassword.addEventListener('click', () => {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            
            const icon = togglePassword.querySelector('i');
            if (icon) {
                icon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
            }
        });
    }
}

function setLoginLoading(loading) {
    const loginButton = document.getElementById('login-btn');
    const btnText = loginButton?.querySelector('.btn-text');
    const btnSpinner = loginButton?.querySelector('.btn-spinner');
    
    if (loginButton && btnText && btnSpinner) {
        loginButton.disabled = loading;
        
        if (loading) {
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline-block';
        } else {
            btnText.style.display = 'inline-block';
            btnSpinner.style.display = 'none';
        }
    }
}

function showLoginScreen() {
    const loginScreen = document.getElementById('login-screen');
    const dashboardScreen = document.getElementById('dashboard-screen');
    
    if (loginScreen) loginScreen.style.display = 'flex';
    if (dashboardScreen) dashboardScreen.style.display = 'none';
}

function showDashboard() {
    const loginScreen = document.getElementById('login-screen');
    const dashboardScreen = document.getElementById('dashboard-screen');
    
    if (loginScreen) loginScreen.style.display = 'none';
    if (dashboardScreen) dashboardScreen.style.display = 'block';
    
    // Atualizar nome do usu√°rio
    updateUserDisplay();
    
    // Chamar callback para inicializar aplica√ß√£o
    if (initApplicationCallback) {
        initApplicationCallback().catch(error => {
            console.error('Erro ao inicializar aplica√ß√£o:', error);
            mostrarNotificacao('Erro', 'Erro ao carregar dados da aplica√ß√£o', 'error');
        });
    }
}

function updateUserDisplay() {
    const userNameElement = document.getElementById('user-name');
    
    if (userNameElement && currentUser) {
        userNameElement.textContent = currentUser.name || currentUser.email || 'Usu√°rio';
    }
}

export function initLogoutButton() {
    const logoutButton = document.getElementById('btn-logout');
    
    if (logoutButton) {
        logoutButton.addEventListener('click', () => {
            logout();
        });
    }
}
